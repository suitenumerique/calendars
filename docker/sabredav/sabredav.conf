<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/sabredav
    
    <Directory /var/www/sabredav>
        AllowOverride All
        Require all granted
        Options -Indexes +FollowSymLinks
    </Directory>
    
    # Set REMOTE_USER from X-Forwarded-User header (set by Django proxy)
    # This allows sabre/dav to use Apache auth backend
    <IfModule mod_headers.c>
        RequestHeader set REMOTE_USER %{HTTP:X-Forwarded-User}e env=HTTP_X_FORWARDED_USER
    </IfModule>
    
    # Rewrite rules for CalDAV
    RewriteEngine On
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ server.php [QSA,L]
    
    # Well-known CalDAV discovery
    RewriteRule ^\.well-known/caldav / [R=301,L]
    
    ErrorLog ${APACHE_LOG_DIR}/sabredav_error.log
    CustomLog ${APACHE_LOG_DIR}/sabredav_access.log combined
</VirtualHost>
