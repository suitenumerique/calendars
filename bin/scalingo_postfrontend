#!/bin/bash

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output

echo "-----> Running post-frontend script"

# Move the frontend build to the nginx root and clean up
mkdir -p build/
mv src/frontend/apps/calendars/out build/frontend-out

mv src/backend/* ./
mv src/nginx/* ./

echo "3.13" > .python-version

# --- PHP + SabreDAV setup ---
echo "-----> Installing PHP 8.3 from Ubuntu packages"

PHP_PREFIX=".php"
DEB_DIR="/tmp/php-debs"
mkdir -p "$DEB_DIR" "$PHP_PREFIX"

# Hardcoded Launchpad URLs for PHP 8.3.6-0maysync1 (Ubuntu Noble amd64)
# Source: https://launchpad.net/ubuntu/noble/amd64/php8.3-fpm/8.3.6-0maysync1
declare -A PHP_DEBS=(
  [php8.3-cli]="http://launchpadlibrarian.net/724872605/php8.3-cli_8.3.6-0maysync1_amd64.deb"
  [php8.3-fpm]="http://launchpadlibrarian.net/724872610/php8.3-fpm_8.3.6-0maysync1_amd64.deb"
  [php8.3-common]="http://launchpadlibrarian.net/724872606/php8.3-common_8.3.6-0maysync1_amd64.deb"
  [php8.3-opcache]="http://launchpadlibrarian.net/724872623/php8.3-opcache_8.3.6-0maysync1_amd64.deb"
  [php8.3-readline]="http://launchpadlibrarian.net/724872627/php8.3-readline_8.3.6-0maysync1_amd64.deb"
  [php8.3-pgsql]="http://launchpadlibrarian.net/724872624/php8.3-pgsql_8.3.6-0maysync1_amd64.deb"
  [php8.3-xml]="http://launchpadlibrarian.net/724872633/php8.3-xml_8.3.6-0maysync1_amd64.deb"
  [php8.3-mbstring]="http://launchpadlibrarian.net/724872617/php8.3-mbstring_8.3.6-0maysync1_amd64.deb"
  [php8.3-curl]="http://launchpadlibrarian.net/724872607/php8.3-curl_8.3.6-0maysync1_amd64.deb"
  [php-common]="http://launchpadlibrarian.net/710804987/php-common_93ubuntu2_all.deb"
)

for pkg in "${!PHP_DEBS[@]}"; do
  echo "       Downloading ${pkg}"
  curl -fsSL -o "$DEB_DIR/${pkg}.deb" "${PHP_DEBS[$pkg]}"
done

for deb in "$DEB_DIR"/*.deb; do
  dpkg-deb -x "$deb" "$PHP_PREFIX"
done

# Fix broken conf.d symlinks: they point to absolute /etc/php/... paths
# but the files are inside our .php prefix. Re-link them.
MODS_DIR="$PHP_PREFIX/etc/php/8.3/mods-available"
for conf_dir in "$PHP_PREFIX/etc/php/8.3/cli/conf.d" "$PHP_PREFIX/etc/php/8.3/fpm/conf.d"; do
  if [ -d "$conf_dir" ]; then
    for link in "$conf_dir"/*.ini; do
      [ -L "$link" ] || continue
      target_basename="$(basename "$(readlink "$link")")"
      if [ -f "$MODS_DIR/$target_basename" ]; then
        ln -sf "$PWD/$MODS_DIR/$target_basename" "$link"
      fi
    done
  fi
done

# Create php wrapper
EXT_DIR="$(ls -d "$PHP_PREFIX"/usr/lib/php/20* 2>/dev/null | head -1)"
cat > bin/php << WRAPPER
#!/bin/bash
DIR="\$(cd "\$(dirname "\$0")/.." && pwd)"
PHP_INI_SCAN_DIR="\$DIR/.php/etc/php/8.3/cli/conf.d" \\
  exec "\$DIR/.php/usr/bin/php8.3" -d "extension_dir=\$DIR/${EXT_DIR}" "\$@"
WRAPPER
chmod +x bin/php

echo "-----> PHP version: $(bin/php -v | head -1)"
echo "-----> PHP modules: $(bin/php -m | tr '\n' ' ')"

# Download Composer and install SabreDAV dependencies
echo "-----> Installing SabreDAV dependencies"
curl -fsSL -o bin/composer.phar \
  https://getcomposer.org/download/latest-stable/composer.phar
cp -r docker/sabredav sabredav
cd sabredav
../bin/php ../bin/composer.phar install \
  --no-dev --optimize-autoloader --no-interaction
cd ..
