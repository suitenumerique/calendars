# ERB templated nginx configuration
# see https://doc.scalingo.com/platform/deployment/buildpacks/nginx

upstream backend_server {
	server localhost:8000 fail_timeout=0;
}

server {
	
	listen <%= ENV["PORT"] %>;
	server_name _;

    root /app/build/frontend-out;
    
    error_page 404 /404.html;

    # Django rest framework and external API
    location ~ ^/(api|external_api)/ {
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_redirect off;
        proxy_pass http://backend_server;
    }

    # CalDAV well-known discovery
    location = /.well-known/caldav {
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_redirect off;
        proxy_pass http://backend_server;
    }

    # Django views (RSVP, iCal export)
    location ^~ /rsvp/ {
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_redirect off;
        proxy_pass http://backend_server;
    }

    location ^~ /ical/ {
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_redirect off;
        proxy_pass http://backend_server;
    }

    # Django admin
    location ^~ /admin/ {
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_redirect off;
		proxy_pass http://backend_server;
	}

    location ~ "^/401/?$" {
        try_files $uri /401.html;
    }

    location ~ "^/403/?$" {
        try_files $uri /403.html;
    }
    
    location = /404.html {
        internal;
    }

    # Frontend export
    location / {
        try_files $uri $uri.html $uri/ =404;
    }

}

# Internal CalDAV server (SabreDAV via PHP-FPM)
# Only accessible from localhost â€” Django proxies to this
server {
    listen 127.0.0.1:9001;
    server_name _;

    location / {
        include fastcgi_params;
        fastcgi_pass unix:/tmp/php-fpm.sock;
        fastcgi_param SCRIPT_FILENAME /app/sabredav/server.php;
        fastcgi_read_timeout 60;
    }
}
